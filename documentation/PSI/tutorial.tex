\documentclass[12pt,a4paper]{article}
\usepackage[in]{fullpage}
\usepackage[utf8x]{inputenc}
\usepackage{cite}
%\usepackage{listings}
\usepackage[usenames]{xcolor}
\usepackage{graphicx}
\usepackage{hyperref}

%\lstset{ %
%  basicstyle=\footnotesize,        % the size of the fonts that are used for the code
%  breakatwhitespace=true,          % sets if automatic breaks should only happen at whitespace
%  breaklines=true,                 % sets automatic line breaking
%  commentstyle=\color{gray},    % comment style
%  keepspaces=true,                 % keeps spaces in text, useful for keeping indentation of code (possibly needs columns=flexible)
%  language=bash                 % the language of the code
%}

%opening
\title{Introduction to the Timing System}
%\author{Sa≈°o Skube, PSI}

\begin{document}

\maketitle

\tableofcontents
\newpage

\section{Introduction}
A timing system consists of an Event Generator (EVG), a series of Event Receivers (EVR), software controlling them and a timing network. EVG generates a series of events, which are delivered to EVRs through a timing network. An EVR is then configured to respond to specific events in various ways, including processing EPICS records, generating pulses, synchronized clock or custom signals on its outputs.
This document contains step-by-step instructions to configuring some of the basic functionalities of the Event Receiver.

\section{Quick start}\label{sec:Quick start}
To set up a timing system we need a VME crate, a Single Board Computer (SBC) and an EVR. A VME crate has a number of slots where SBC, EVR and other components can be inserted. Slot numbering should be checked with the VME crate documentation. To use a VME crate for the turorials, check that:
\begin{itemize}
	 \item a VME64x IFC 1210 Single Board Computer is inserted into VME crate slot 1 (how to set up IFC 1210~\cite{ifc}),
	\item  an EVR is inserted in slot 2,
	\item the EVR is connected to the timing network through an optical cable.
\end{itemize}

To set up an IOC application for Event Receiver we need a startup script and a substitution file. The following steps demonstrate how to prepare such a SWIT compatible IOC application:
\begin{enumerate}

	\item Create a \textbf{project folder}, eg. \texttt{MTEST-VME-EVRTEST} and a \textbf{sub-folder named} \textit{cfg} in your project folder: \texttt{MTEST-VME-EVRTEST/cfg/}
\begin{verbatim}
	mkdir MTEST-VME-EVRTEST
	cd MTEST-VME-EVRTEST
	mkdir cfg
\end{verbatim}

	\item Copy the \textbf{startup script} to your project. Use the following command in your project folder:
\begin{verbatim}
	cp /fin/devl/iocBoot/templates/slejko/EVR_VME.startup 
	    MTEST-VME-EVRTEST_startup.script
\end{verbatim}

	The startup script should look similar to 
\begin{verbatim}
	##System configuration
	epicsEnvSet SYS MTEST-VME-EVRTEST
	
	### EVR configuration
	#epicsEnvSet EVR EVR0 ##EVR name (default EVR0)
	#epicsEnvSet EVR_SLOT 2 ##EVR SLOT (default slot 2)
	
	< $(TEMPLATE\DIR)/EVR_VME.startup
	
## END OF EVR configuration
\end{verbatim}

System name (\texttt{SYS}) variable must be defined. When omitted, the \texttt{EVR} name and \texttt{EVR\_SLOT} will fall-back to default values. Using the above startup script, the system name is set to \textit{MTEST-VME-EVRTEST}, and the Event Receiver named \textit{EVR0} is placed in the physical slot 2 of the VME crate. Line \texttt{$<$ \$(TEMPLATE\_DIR)/EVR\_VME.startup} includes a generic EVR startup script, so it should not be changed by the user.

	\item Copy the \textbf{substitution file}~\cite{substitution_git} to \texttt{MTEST-VME-EVRTEST/cfg/EVR.subs}. This substitution file can always be used as a starting point for new applications. Use the following command in your project folder: 
\begin{verbatim}
	cp /fin/devl/iocBoot/templates/slejko/EVR.subs cfg/
\end{verbatim}
\end{enumerate}

The macro definitions in the substitution file are used to configure the EVR. All the available macros are already present in the substitution file~\cite{substitution_git} and set to their default values, so the user can simply change the desired values, remove unused macros (same effect as leaving them with their default value). Detailed description of the substitution file is available in the EVR manual~\cite{evr_manual}.

\paragraph{Command summary} for creating a new IOC application:
\begin{verbatim}
	mkdir MTEST-VME-EVRTEST
	cd MTEST-VME-EVRTEST
	mkdir cfg
	cp /fin/devl/iocBoot/templates/slejko/EVR_VME.startup 
	    MTEST-VME-EVRTEST_startup.script
	cp /fin/devl/iocBoot/templates/slejko/EVR.subs cfg/
\end{verbatim}

\section{Generate a pulse uppon receiving an event}
	\includegraphics[]{./img/pulser}
	
This tutorial demonstrates how to configure an EVR to generate a 80ns wide pulse, 40ns after each occurance of event 4 and output it through the front panel TTL output 0(FrontOut0). In order to achieve this, pulser 3 delay and width are configured by setting macro value of \texttt{Pul3-Delay-SP} to 40 and of \texttt{Pul3-Width-SP} to 80. The value of the output source macro \texttt{FrontOut0-Src-SP} is set to 3, which configures the front panel output 0(FrontOut0) to use pulser 3 as its source. Finally pulser 3 is set to trigger on event 4 by setting macro value \texttt{EVT} to 4 in \textit{evr-pulserMap.template}. 

	\includegraphics[width=\columnwidth]{./img/pulserSignal}


\subsection{Instructions:}
\begin{enumerate}
	\item Create a \textbf{project folder}, eg. \texttt{MTEST-VME-EVRTEST}.
	\item Copy \textbf{startup script} and an example \textbf{substitution file} to your project. Use the following commands in your project folder:
\begin{verbatim}
	cp /fin/devl/iocBoot/templates/slejko/EVR_VME.startup 
	    MTEST-VME-EVRTEST_startup.script
	cp /fin/devl/iocBoot/templates/slejko/EVR.subs cfg/
\end{verbatim}

	\item Set the macro values in the substitution file according to this snippet:
\begin{verbatim}
	file "$(TEMPLATE_DIR)/evr-vmerf230.template"
	{
	  {
	    ...
	    Pul3-Delay-SP=40,
	    Pul3-Width-SP=80,
	    ...
	    FrontOut0-Src-SP=3,
	    ...
	  }
	}

	file "$(TEMPLATE_DIR)/evr-pulserMap.template"{
	pattern { PID   F,       EVT, ID}
	        ...
	        { 3,    Trig,    4,   0 }
	        ...
	}
\end{verbatim}

	\item Optionally, you can remove all the macros whose values you did not change. 
	\item \textbf{Install the} prepared \textbf{IOC} by running command \texttt{swit -V} from your project folder \textit{MTEST-VME-EVRTEST}.
\end{enumerate}
\subsection{Substitution snippet explanation:}

First we set up the pulse generator:
\begin{itemize}
	\item \textbf{Pul3-Delay-SP} [ns]: Set the delay from when the event occurs to the start of the pulse (pulse rising edge) for pulser 3. 
	\item \textbf{Pul3-Width-SP} [ns]: Set the pulse width (time between the pulse rising and falling edge) for pulser 3.
\end{itemize}

Next, we use the macro  \textbf{FrontOut0-Src-SP} to set the source of the front panel output 0  to pulser 3 through a mapping. Mappings 0-15 correspond to pulsers 0-15. A complete list of mappings is available in the EVR manual~\cite{evr_manual}.

Finally set the Pulser 3 to trigger on reception of the event 4:
\begin{itemize}
	\item \textbf{PID}: Select Pulser 3
	\item \textbf{F}: Select the \textit{Trigger} function of the pulser
	\item \textbf{EVT}: Map Pulser 3 Trig function to event 4
	\item \textbf{ID}: Unique ID for each PID-F combination.
\end{itemize}

In order to use different pulser simply change the pulser number, eg. using \texttt{Pul5-Delay-SP} instead of \texttt{Pul3-Delay-SP} sets the delay of pulser 5 instead of pulser 3.
Similar is for outputs, eg. using \texttt{FrontOut1-Src-SP} instead of \texttt{FrontOut0-Src-SP} sets the output source signal of front panel output 1 instead of front panel output 0.

\section{Process an EPICS record uppon receiving an event}
This tutorial demonstrates how to use macro substitutions to trigger an EPICS event number 1 and increase a counter uppon each reception of event 1 from the timing network.

The counter is a calc record, that counts how many times the event 1 was received from the timing system. Its name is in form of \texttt{\$(SYS)-\$(EVR):Event-\$(EVT)-Cnt-I}, where \texttt{\$(SYS)} represents the system name (set in the startup script), \texttt{\$(EVR)} represents the Event Receiver name (set in the startup script, default "EVR0") and \texttt{\$(EVT)} is the event from the timing network (in this case "1"), thus the full \textbf{name of the counter record is} \texttt{MTEST-VME-EVRTEST-EVR0:Event-1-Cnt-I}.

\subsection{Instructions:}
\begin{enumerate}
	\item Create a \textbf{project folder}, eg. \texttt{MTEST-VME-EVRTEST}.
	\item Copy \textbf{startup script} and an example \textbf{substitution file} to your project. Use the following commands in your project folder:
\begin{verbatim}
	cp /fin/devl/iocBoot/templates/slejko/EVR_VME.startup 
	    MTEST-VME-EVRTEST_startup.script
	cp /fin/devl/iocBoot/templates/slejko/EVR.subs cfg/
\end{verbatim}
	\item Set the macro values in the substitution file according to this snippet:
\begin{verbatim}
	file "$(TEMPLATE_DIR)/evr-softEvent.template"{
	pattern { EVT,    CODE }
	        { "1",    "1"}
	        ...
	}
\end{verbatim}
	\item Optionally, you can remove all the macros whose values you did not change. 

	\item \textbf{Install the} prepared \textbf{IOC} by running command \texttt{swit -V} from your project folder \textit{MTEST-VME-EVRTEST}.
\end{enumerate}

\subsection{Substitution snippet explanation:}
\begin{itemize}
	\item \textbf{EVT}: Set to event received from timing network (hardware).
	\item \textbf{CODE}: Set to EPICS event number (software).
It is suggested that macros \textit{EVT} and \textit{CODE} are set to the same value for simplicity, allthough this is not mandatory.
\end{itemize}

\section{Generate a clock signal}
	\includegraphics[width=\columnwidth]{./img/prescaler}
%\begin{figure}[htbp]
%\centering
%\includegraphics{img/prescaler}
%\caption{prescaler}
%\end{figure}

Event Receivers have synchronized event clock across the timing system (the same phase and frequency). The event clock can be prescaled and mapped to the EVR output. In order to achieve this, the macro \texttt{PS0-Div-SP} is set to 2, which configures the prescaler 0(PS0) to divide the event clock frequency by 2. Then the value of the output source macro \texttt{FrontOut1-Src-SP} is set to 40, which configures the front panel output 1(FrontOut1) to use prescaler 0 as its source.

\subsection{Instructions:}
\begin{enumerate}
	\item Create a \textbf{project folder}, eg. \texttt{MTEST-VME-EVRTEST}.
	\item Copy \textbf{startup script} and an example \textbf{substitution file} to your project. Use the following commands in your project folder:
\begin{verbatim}
	cp /fin/devl/iocBoot/templates/slejko/EVR_VME.startup 
	    MTEST-VME-EVRTEST_startup.script
	cp /fin/devl/iocBoot/templates/slejko/EVR.subs cfg/
\end{verbatim}

	\item Set the macro values in the substitution file according to this snippet:
\begin{verbatim}
	file "$(TEMPLATE_DIR)/evr-vmerf230.template"
	{
	  {
	    ...
	    PS0-Div-SP=2,
	    ...
	    FrontOut1-Src-SP=40,
		    ...
	  }
	}
\end{verbatim}

	\item Optionally, you can remove all the macros whose values you did not change. 
	\item \textbf{Install the} prepared \textbf{IOC} by running command \texttt{swit -V} from your project folder \textit{MTEST-VME-EVRTEST}.
\end{enumerate}

\subsection{Substitution snippet explanation:}
\begin{itemize}
	\item \textbf{PS0-Div-SP}: Set the Prescaler 0 to divide event clock frequency by 2.
	\item \textbf{FrontOut1-Src-SP}: Set the source of the Front Panel Output 1  to Prescaler 0 through a mapping. Mappings 40-42 correspond to prescalers 0-2. A complete list of mappings is available in the EVR manual~\cite{evr_manual}.
\end{itemize}

In order to use different prescaler, simply change the prescaler number, eg. using \texttt{PS2-Div-SP} instead of \texttt{PS0-Div-SP} sets the divider of prescaler 2 instead of prescaler 0.
Similar is for outputs, eg. using \texttt{FrontOut0-Src-SP} instead of \texttt{FrontOut1-Src-SP} sets the output source signal of front panel output 0 instead of front panel output 1.

\section{Output a Distributed Bus bit}
	\includegraphics[]{./img/dbus}
	
This tutorial demonstrates how to set up the DBus bit as a source of an EVR front panel output. To achieve this, the front panel output 0 should be mapped to the distributed bus bit (signal) 0. This is configured by setting the value of the output source macro \texttt{FrontOut1-Src-Sp} to 32. Mapping 32 corresponds to the DBus bit 0.

\subsection{Instructions:}
\begin{enumerate}
	\item Create a \textbf{project folder}, eg. \texttt{MTEST-VME-EVRTEST}.
	\item Copy \textbf{startup script} and an example \textbf{substitution file} to your project. Use the following commands in your project folder:
\begin{verbatim}
	cp /fin/devl/iocBoot/templates/slejko/EVR_VME.startup 
	    MTEST-VME-EVRTEST_startup.script
	cp /fin/devl/iocBoot/templates/slejko/EVR.subs cfg/
\end{verbatim}

	\item Set the macro values in the substitution file according to this snippet:
\begin{verbatim}
	file "$(TEMPLATE_DIR)/evr-vmerf230.template"
	{
	  {
	    ...
	    FrontOut1-Src-SP=32,
	    ...
	  }
	}
\end{verbatim}

	\item Optionally, you can remove all the macros whose values you did not change. 
	\item \textbf{Install the} prepared \textbf{IOC} by running command \texttt{swit -V} from your project folder \textit{MTEST-VME-EVRTEST}.
\end{enumerate}

\subsection{Substitution snippet explanation:}
\begin{itemize}
	\item \textbf{FrontOut1-Src-SP}: Set the source of the front panel output 1  to DBus bit 0 through a mapping. Mappings 32-39 correspond to DBus bits 0-7. A complete list of mappings is available in the EVR manual~\cite{evr_manual}.
\end{itemize}

In order to use different front panel output, simply change the front panel output number, eg. using \texttt{FrontOut0-Src-SP} instead of \texttt{FrontOut1-Src-SP} sets the output source signal of front panel output 0 instead of front panel output 1.

\bibliographystyle{plain}
\bibliography{references}

\end{document}
