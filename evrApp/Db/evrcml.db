# Extra controls for CML/GTX outputs
#
# Macros:
#  P = record name prefix
#  O = Object suffix (usually the same as for evrout.db)
#  OBJ = devObj name

record(bo, "$(P)$(O)enable") {
  field(DTYP, "Obj Prop bool")
  field(OUT, "@OBJ=$(OBJ), PROP=Enable")
  field(PINI, "YES")
  field(UDF, "0")
  field(VAL, "0")
  field(ZNAM, "Disabled")
  field(ONAM, "Enabled")
  info(autosaveFields_pass0, "VAL")
}

record(bo, "$(P)$(O)power") {
  field(DTYP, "Obj Prop bool")
  field(OUT, "@OBJ=$(OBJ), PROP=Power")
  field(PINI, "YES")
  field(UDF, "0")
  field(VAL, "0")
  field(ZNAM, "Off")
  field(ONAM, "On")
  info(autosaveFields_pass0, "VAL")
}

record(bo, "$(P)$(O)reset") {
  field(DTYP, "Obj Prop bool")
  field(OUT, "@OBJ=$(OBJ), PROP=Reset")
  field(PINI, "YES")
  field(UDF, "0")
  field(VAL, "0")
  field(ZNAM, "Normal")
  field(ONAM, "Reset")
  info(autosaveFields_pass0, "VAL")
}

record(mbbo, "$(P)$(O)mode") {
  field( DTYP, "Obj Prop uint16")
  field( OUT , "@OBJ=$(OBJ), PROP=Mode")
  field( PINI, "YES")
  field( ZRST, "4x Pattern")
  field( ONST, "Frequency")
  field( TWST, "Waveform")
  field( ZRVL, "0")
  field( ONVL, "1")
  field( TWVL, "2")
  field( THSV, "INVALID")
  field( FRSV, "INVALID")
  field( FVSV, "INVALID")
  field( SXSV, "INVALID")
  field( SVSV, "INVALID")
  field( EISV, "INVALID")
  field( NISV, "INVALID")
  field( TESV, "INVALID")
  field( ELSV, "INVALID")
  field( TVSV, "INVALID")
  field( TTSV, "INVALID")
  field( FTSV, "INVALID")
  field( FFSV, "INVALID")
  field( UNSV, "INVALID")
  field( IVOA, "Don't drive outputs")
  info(autosaveFields_pass0, "VAL")
}

record(longin, "$(P)$(O)res:mult") {
  field(DTYP, "Obj Prop uint32")
  field(INP, "@OBJ=$(OBJ), PROP=Freq Mult")
  field(HIGH, "65535")
  field(LOW, "20")
  field(HSV, "INVALID")
  field(LSV, "INVALID")
}

record(calcout, "$(P)$(O)res") {
  field(INPA, "$(P)clock:period CP")
  field(INPB, "$(P)$(O)res:mult PP")
  field(CALC, "1e9*A/B")
  field(EGU , "ns")
  field(TSEL, "$(P)clock:period.TIME CA")
  field(FLNK, "$(P)$(O)res:fo")
}

record(fanout, "$(P)$(O)res:fo") {
  field(DESC, "Clock change resync")
  field(TSEL, "$(P)$(O)res.TIME")
  field(LNK1, "$(P)$(O)freq:high")
  field(LNK2, "$(P)$(O)freq:low")
  field(LNK3, "$(P)$(O)pat:x:calc")
  field(LNK4, "$(P)$(O)pat:dly:calc")
}

# Rising pattern

record(mbboDirect, "$(P)$(O)rise:0") {
  field(DTYP, "Raw Soft Channel")
  field(DESC, "Bits 0-15")
  field(NOBT, "16")
  field(OUT , "$(P)$(O)rise:calc.A PP")
  field(PINI, "YES")
  info(autosaveFields_pass0, "VAL")
}

record(mbboDirect, "$(P)$(O)rise:1") {
  field(DTYP, "Raw Soft Channel")
  field(DESC, "Bits 16-31")
  field(NOBT, "16")
  field(OUT , "$(P)$(O)rise:calc.B PP")
  field(PINI, "YES")
  info(autosaveFields_pass0, "VAL")
}

record(mbboDirect, "$(P)$(O)rise:2") {
  field(DTYP, "Raw Soft Channel")
  field(DESC, "Bits 32-39")
  field(NOBT, "16")
  field(SHFT, "8")
  field(OUT , "$(P)$(O)rise:calc.C PP")
  field(PINI, "YES")
  info(autosaveFields_pass0, "VAL")
}

record(aSub, "$(P)$(O)rise:calc") {
  field(SNAM, "Bit Array Gen")
  field(BRSV, "INVALID")
  field( FTA, "USHORT")
  field( FTB, "USHORT")
  field( FTC, "USHORT")
  field(FTVA, "UCHAR")
  field(NOVA, "40")
  field(OUTA, "$(P)$(O)rise PP")
}

record(waveform, "$(P)$(O)rise") {
  field(DESC, "Rising edge pattern")
  field(DTYP, "Obj Prop waveform out")
  field(INP, "@OBJ=$(OBJ), PROP=Pat Rise")
  field(PINI, "YES")
  field(FTVL, "UCHAR")
  field(NELM, "40")
  field(HOPR, "1")
  field(LOPR, "0")
}

# High pattern

record(mbboDirect, "$(P)$(O)high:0") {
  field(DTYP, "Raw Soft Channel")
  field(DESC, "Bits 0-15")
  field(NOBT, "16")
  field(OUT , "$(P)$(O)high:calc.A PP")
  field(PINI, "YES")
  info(autosaveFields_pass0, "VAL")
}

record(mbboDirect, "$(P)$(O)high:1") {
  field(DTYP, "Raw Soft Channel")
  field(DESC, "Bits 16-31")
  field(NOBT, "16")
  field(OUT , "$(P)$(O)high:calc.B PP")
  field(PINI, "YES")
  info(autosaveFields_pass0, "VAL")
}

record(mbboDirect, "$(P)$(O)high:2") {
  field(DTYP, "Raw Soft Channel")
  field(DESC, "Bits 32-39")
  field(NOBT, "16")
  field(SHFT, "8")
  field(OUT , "$(P)$(O)high:calc.C PP")
  field(PINI, "YES")
  info(autosaveFields_pass0, "VAL")
}

record(aSub, "$(P)$(O)high:calc") {
  field(SNAM, "Bit Array Gen")
  field(BRSV, "INVALID")
  field( FTA, "USHORT")
  field( FTB, "USHORT")
  field( FTC, "USHORT")
  field(FTVA, "UCHAR")
  field(NOVA, "40")
  field(OUTA, "$(P)$(O)high PP")
}

record(waveform, "$(P)$(O)high") {
  field(DESC, "Rising edge pattern")
  field(DTYP, "Obj Prop waveform out")
  field(INP, "@OBJ=$(OBJ), PROP=Pat High")
  field(PINI, "YES")
  field(FTVL, "UCHAR")
  field(NELM, "40")
  field(HOPR, "1")
  field(LOPR, "0")
}

# Falling pattern

record(mbboDirect, "$(P)$(O)fall:0") {
  field(DTYP, "Raw Soft Channel")
  field(DESC, "Bits 0-15")
  field(NOBT, "16")
  field(OUT , "$(P)$(O)fall:calc.A PP")
  field(PINI, "YES")
  info(autosaveFields_pass0, "VAL")
}

record(mbboDirect, "$(P)$(O)fall:1") {
  field(DTYP, "Raw Soft Channel")
  field(DESC, "Bits 16-31")
  field(NOBT, "16")
  field(OUT , "$(P)$(O)fall:calc.B PP")
  field(PINI, "YES")
  info(autosaveFields_pass0, "VAL")
}

record(mbboDirect, "$(P)$(O)fall:2") {
  field(DTYP, "Raw Soft Channel")
  field(DESC, "Bits 32-39")
  field(NOBT, "16")
  field(SHFT, "8")
  field(OUT , "$(P)$(O)fall:calc.C PP")
  field(PINI, "YES")
  info(autosaveFields_pass0, "VAL")
}

record(aSub, "$(P)$(O)fall:calc") {
  field(SNAM, "Bit Array Gen")
  field(BRSV, "INVALID")
  field( FTA, "USHORT")
  field( FTB, "USHORT")
  field( FTC, "USHORT")
  field(FTVA, "UCHAR")
  field(NOVA, "40")
  field(OUTA, "$(P)$(O)fall PP")
}

record(waveform, "$(P)$(O)fall") {
  field(DESC, "Rising edge pattern")
  field(DTYP, "Obj Prop waveform out")
  field(INP, "@OBJ=$(OBJ), PROP=Pat Fall")
  field(PINI, "YES")
  field(FTVL, "UCHAR")
  field(NELM, "40")
  field(HOPR, "1")
  field(LOPR, "0")
}

# Low pattern

record(mbboDirect, "$(P)$(O)low:0") {
  field(DTYP, "Raw Soft Channel")
  field(DESC, "Bits 0-15")
  field(NOBT, "16")
  field(OUT , "$(P)$(O)low:calc.A PP")
  field(PINI, "YES")
  info(autosaveFields_pass0, "VAL")
}

record(mbboDirect, "$(P)$(O)low:1") {
  field(DTYP, "Raw Soft Channel")
  field(DESC, "Bits 16-31")
  field(NOBT, "16")
  field(OUT , "$(P)$(O)low:calc.B PP")
  field(PINI, "YES")
  info(autosaveFields_pass0, "VAL")
}

record(mbboDirect, "$(P)$(O)low:2") {
  field(DTYP, "Raw Soft Channel")
  field(DESC, "Bits 32-39")
  field(NOBT, "16")
  field(SHFT, "8")
  field(OUT , "$(P)$(O)low:calc.C PP")
  field(PINI, "YES")
  info(autosaveFields_pass0, "VAL")
}

record(aSub, "$(P)$(O)low:calc") {
  field(SNAM, "Bit Array Gen")
  field(BRSV, "INVALID")
  field( FTA, "USHORT")
  field( FTB, "USHORT")
  field( FTC, "USHORT")
  field(FTVA, "UCHAR")
  field(NOVA, "40")
  field(OUTA, "$(P)$(O)low PP")
}

record(waveform, "$(P)$(O)low") {
  field(DESC, "Rising edge pattern")
  field(DTYP, "Obj Prop waveform out")
  field(INP, "@OBJ=$(OBJ), PROP=Pat Low")
  field(PINI, "YES")
  field(FTVL, "UCHAR")
  field(NELM, "40")
  field(HOPR, "1")
  field(LOPR, "0")
}

# frequency mode

record(bo, "$(P)$(O)freq:level") {
  field(DTYP, "Obj Prop bool")
  field(OUT, "@OBJ=$(OBJ), PROP=Freq Trig Lvl")
  field(PINI, "YES")
  field(UDF, "0")
  field(VAL, "0")
  field(ZNAM, "Active high")
  field(ONAM, "Active low")
  info(autosaveFields_pass0, "VAL")
}

record(ao, "$(P)$(O)freq:high") {
  field(DESC, "Time active")
  field(DTYP, "Obj Prop double")
  field(OUT, "@OBJ=$(OBJ), PROP=Counts High")
  field(PINI, "YES")
  field(UDF , "0")
  field(VAL , "10")
  field(EGU , "ns")
  field(LINR, "LINEAR")
  field(ESLO, "1e9")
  field(PREC, "3")
  field(FLNK, "$(P)$(O)freq:high:rbv")
  info(autosaveFields_pass0, "VAL")
}

record(longin, "$(P)$(O)freq:high:rbv") {
  field(DTYP, "Obj Prop uint32")
  field(INP, "@OBJ=$(OBJ), PROP=Counts High")
  field(HIGH, "65535")
  field(LOW, "20")
  field(HSV, "INVALID")
  field(LSV, "INVALID")
}

record(ao, "$(P)$(O)freq:low") {
  field(DESC, "Time inactive")
  field(DTYP, "Obj Prop double")
  field(OUT, "@OBJ=$(OBJ), PROP=Counts Low")
  field(PINI, "YES")
  field(UDF , "0")
  field(VAL , "10")
  field(EGU , "ns")
  field(LINR, "LINEAR")
  field(ESLO, "1e9")
  field(PREC, "3")
  field(FLNK, "$(P)$(O)freq:low:rbv")
  info(autosaveFields_pass0, "VAL")
}

record(longin, "$(P)$(O)freq:low:rbv") {
  field(DTYP, "Obj Prop uint32")
  field(INP, "@OBJ=$(OBJ), PROP=Counts Low")
  field(HIGH, "65535")
  field(LOW, "20")
  field(HSV, "INVALID")
  field(LSV, "INVALID")
}

record(waveform, "$(P)$(O)pat") {
  field(DESC, "Pattern setting")
  field(DTYP, "Obj Prop waveform out")
  field(INP, "@OBJ=$(OBJ), PROP=Waveform")
  field(PINI, "YES")
  field(FTVL, "UCHAR")
  field(NELM, "$(MAX=40940)") # 20*2047
  field(HOPR, "1")
  field(LOPR, "0")
  field(FLNK, "$(P)$(O)pat:rbv")
  info(autosaveFields_pass1, "VAL")
}

record(waveform, "$(P)$(O)pat:rbv") {
  field(DESC, "Pattern readback")
  field(DTYP, "Obj Prop waveform in")
  field(PINI, "YES")
  field(INP, "@OBJ=$(OBJ), PROP=Waveform")
  field(FTVL, "UCHAR")
  field(NELM, "$(MAX=40940)") # 20*2047
  field(HOPR, "1")
  field(LOPR, "0")
  field(FLNK, "$(P)$(O)pat:x:calc")
}

record(aSub, "$(P)$(O)pat:x:calc") {
  field(SNAM, "Timeline")
  field(BRSV, "INVALID")
  field(INPA, "0")
  field( FTA, "DOUBLE")
  field(INPB, "$(P)$(O)res NPP")
  field( FTB, "DOUBLE")
  field(INPC, "$(P)$(O)pat.NORD NPP")
  field( FTC, "LONG")
  field(OUTA, "$(P)$(O)pat:x PP")
  field(FTVA, "DOUBLE")
  field(NOVA, "$(MAX=40940)") # 20*2047
  field(TSEL, "$(P)$(O)pat:rbv.TIME")
}

record(waveform, "$(P)$(O)pat:x") {
  field(FTVL, "DOUBLE")
  field(NELM, "$(MAX=40940)")
  field(EGU , "ns")
}

# Delay gen calculator for CML waveform

record(bo, "$(P)$(O)pat:dly:ena") {
  field(DESC, "Disable calculator")
  field(ONAM, "Enabled")
  field(ZNAM, "Disabled")
  field(UDF , "0")
  info(autosaveFields_pass0, "VAL")
}

record(ao, "$(P)$(O)pat:dly") {
  field(PINI, "YES")
  field(OUT , "$(P)$(O)pat:dly:calc.A PP")
  field(EGU , "ns")
  field(UDF , "0")
  field(VAL , "16")
  info(autosaveFields_pass0, "VAL EGU")
}

record(ao, "$(P)$(O)pat:dly:wth") {
  field(PINI, "YES")
  field(OUT , "$(P)$(O)pat:dly:calc.B PP")
  field(EGU , "ns")
  field(UDF , "0")
  field(VAL , "50")
  info(autosaveFields_pass0, "VAL EGU")
}

record(aSub, "$(P)$(O)pat:dly:calc") {
  field(SDIS, "$(P)$(O)pat:dly:ena")
  field(DISV, "0")
  field(SNAM, "Delay Gen")
  field(BRSV, "INVALID")
  field( FTA, "DOUBLE")
  field( FTB, "DOUBLE")
  field(INPC, "$(P)$(O)res NPP")
  field( FTC, "DOUBLE")
  field(INPD, "$(P)$(O)res:mult NPP")
  field( FTD, "LONG")
  field(OUTA, "$(P)$(O)pat PP")
  field(FTVA, "UCHAR")
  field(NOVA, "$(MAX=40940)") # 20*2047
}

